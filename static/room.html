<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Room</title>
</head>
<body>
    <a href="/">
        Home
    </a>
    <br/>
    <a href="/" id="songs-url">
        Songs
    </a>
    <br/>
    <h1 style="font-family: sans-serif" id="room"></h1>

    <ul id="songs">
    </ul>

    <div>
        <label for="title">What song do you want to add?</label>
        <input name="title" id="title" value="" placeholder="song...">
    </div>
    <div>
        <input value="Submit" type="submit" onclick="submitform()">
    </div>



    <script>


    const roomDOM = window.document.querySelector("#room");
    const songsDOM = window.document.querySelector("#songs");
    const songUrlDOM = window.document.querySelector("#songs-url");

    const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
    });
    const id = params.id; // "some_value"
    roomDOM.innerHTML = id.slice(0, 6);
    songUrlDOM.setAttribute('href', `/songs/${id}`);

    async function postData(url = '', data = {}) {
        // Default options are marked with *
        const response = await fetch(url, {
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json'
                // 'Content-Type': 'application/x-www-form-urlencoded',
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
            body: JSON.stringify(data) // body data type must match "Content-Type" header
        });
        return response.json(); // parses JSON response into native JavaScript objects
    }

    async function getSongs() {
        return await fetch(`http://127.0.0.1:8080/songs/${id}`)
            .then(async data => {
                data = await data.json();
                if (!data.success) {
                    return;
                }

                let songs = data.data;
                let html = songs.map((s) => `<li>${s.id}, ${s.title}</li>`).join("");
                console.log({ html, len: songs.length });
                songsDOM.innerHTML = html;

                return songs;
            });
    }

    getSongs();

    async function submitform() {
        const title = window.document.querySelector("#title").value;
        await postData(`/songs/${id}`, { title }).then((data) => console.log(data));
        await getSongs();
    }

</script>
</body>
</html>
